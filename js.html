<script>
    function inserirContato()
    {
        // Obter dados
        let nome = document.getElementById('nome').value;
        let sobrenome = document.getElementById('sobrenome').value;
        let email = document.getElementById('email').value;
        let telef = document.getElementById('telef').value;

        // Fechar Modal
        bootstrap.Modal.getInstance(document.getElementById('criarContatoModal')).hide();

        // Apagando a tabela se ela existir
        removerTabelaContatos();

        // Criar Loader
        //criarLoader('divContatos');
        criarLoaderBolinhas('divContatos');

        google.script.run
        .withSuccessHandler(contatoInseridoCorretamente)
        .withFailureHandler(contatoInseridoError)
        .inserirContato(nome, sobrenome, email, telef);
    }

    function contatoInseridoCorretamente()
    {
        // Eliminamos os dados de Input
        document.getElementById('nome').value = '';
        document.getElementById('sobrenome').value = '';
        document.getElementById('email').value = '';
        document.getElementById('telef').value = '';

        // Mostra Notificacao
        criarNotificacaoOk('Contato inserido corretamente', 'CONTATO OK');

        //Eliminamos o loader
        removerLoader();

      // Mostr5amos a tabela de contatos
      criarTabelaContatos();
    }

    function contatoInseridoError()
    {
      criarNotificacaoError('Não podemos inserir o Contato', 'ERRO !!');

      //Eliminamos o loader
      removerLoader();

      // Mostr5amos a tabela de contatos
      criarTabelaContatos();
    }

    function criarTabelaContatos()
    {
        // Apagando a tabela se ela existir
        removerTabelaContatos();

        // Criar Loader
        //criarLoader('divContatos');
        criarLoaderBolinhas('divContatos');

        google.script.run
        .withSuccessHandler(criarTabelaContatosCorretamente)
        .withFailureHandler(criarTabelaContatosError)
        .obterContatos();
    }

    function criarTabelaContatosCorretamente(obj)
    {
        // Debug: ver o que o servidor retornou
        console.log('obterContatos result:', obj);

        // Validações defensivas: garantir que obj é um array com ao menos uma linha (header)
        if(!obj || !Array.isArray(obj) || obj.length === 0 || !Array.isArray(obj[0]))
        {
            removerLoader();
            criarNotificacaoAdvertencia('Nenhum contato encontrado ou formato inválido retornado pelo servidor', 'Atenção');
            return;
        }
        let tabela = document.createElement('table');
        tabela.id = 'tabelaContatos';

        let tabelaHeader = document.createElement('thead');
        let tabelaBody = document.createElement('tbody');

        // Header da tabela
        let primeiraFila = document.createElement('tr');
        for(let i =0; i < obj[0].length; i++)
        {
            let celula = document.createElement('th');
            celula.textContent = obj[0][i];
            primeiraFila.appendChild(celula);   
        }

        // Adicionar coluna de opcoes
        let celulaOpcoes = document.createElement('td');
        celulaOpcoes.textContent = 'Opções';
        celulaOpcoes.classList.add('text-center');
        primeiraFila.appendChild(celulaOpcoes);

        // Adicionar a Fila ao Header da tabela
        tabelaHeader.appendChild(primeiraFila);
        tabela.appendChild(tabelaHeader);

        // Body da tabela
        for(let i = 1; i < obj.length; i++)
        {
            let fila = document.createElement('tr');
            for(let j = 0; j < obj[i].length; j++)
            {
                let celula = document.createElement('td');
                celula.textContent = obj[i][j];
                fila.appendChild(celula); 
            }
            //Adicionar botoes de editar e eliminar
            fila.appendChild(criarBotoesOpcoes(i+1));

            tabelaBody.appendChild(fila);
        };

        // Adicioona,ps o cabeçalho da tabela
        tabelaHeader.classList.add('table-dark');
    
        //Adicionamos o corpo da tabela
        tabela.appendChild(tabelaBody);

        //Adicionamos classes do bootstrap a tabela
        tabela.classList.add('table', 'table-striped', 'border', 'border-4', 'table-dark', 'border-dark');

        //adicionamos a tabela na dic do html
        document.getElementById('divContatos').appendChild(tabela);

        // Mostrar notificação de OK
        criarNotificacaoOk('Contatos obtidos corretamente', 'Sucesso');

        //Eliminamos o loader
        removerLoader();
    }

    function criarBotoesOpcoes(numFila)
    {
        // Criar celula
        let celula = document.createElement('td');
        celula.classList.add('text-center');

        // Criar botao de apagar
        let botaoApagar = document.createElement('button');
        botaoApagar.onclick = () => apagarContato(numFila);
        botaoApagar.classList.add('btn', 'btn-danger', 'm-1');
        //botaoApagar.textContent = 'Apagar';

        // Icone Apagar
        let iconeApagar = document.createElement('i');
        iconeApagar.classList.add('bi', 'bi-trash');
        botaoApagar.appendChild(iconeApagar);

        // Criar botao de editar
        let botaoEditar = document.createElement('button');

        //botaoEditar.onclick = () => EditarContato(numFila);
        botaoEditar.classList.add('btn', 'btn-warning', 'm-1');
        //botaoEditar.textContent = 'Editar';

        // Icone Editar
        let iconeEditar = document.createElement('i');
        iconeEditar.classList.add('bi', 'bi-pencil-square');
        botaoEditar.appendChild(iconeEditar);        

        // Adicionar botoes na Celula
        celula.appendChild(botaoApagar);
        celula.appendChild(botaoEditar);

        // Adicionar celula na Fila
        return celula;
    }

    function apagarContato(numFila)
    {
        // Apagando a tabela se ela existir
        removerTabelaContatos();

        // Criar Loader
        //criarLoader('divContatos');
        criarLoaderBolinhas('divContatos');

        google.script.run
        .withSuccessHandler(contatoApagadoCorretamente)
        .withFailureHandler(contatoApagadoError)
        .apagarContato(numFila);
    }

    function contatoApagadoCorretamente()
    {
        // Mostra Notificacao
        criarNotificacaoOk('Contato apagado corretamente', 'CONTATO APAGADO');

        //Eliminamos o loader
        removerLoader();

        // Mostr5amos a tabela de contatos
        criarTabelaContatos();
    }

    function contatoApagadoError()
    {
        criarNotificacaoError('Não podemos apagar o Contato', 'ERRO !!');
    
        //Eliminamos o loader
        removerLoader();
    
        // Mostr5amos a tabela de contatos
        criarTabelaContatos();
    }

    function criarTabelaContatosError()
    {
        // Mostrar notificaç~cao de Erro
        criarNotificacaoError('Não pode ser lido os contatos', 'ERRO !!');

        //Eliminamos o loader
        removerLoader();
    }




    function criarNotificacao(mensagem, titulo)
    {
        document.getElementById('mensagemNotificacao').textContent = mensagem;
        document.getElementById('tituloNotificacao').textContent = titulo;
        let elementoNotificacao = document.getElementById('notificacao');
        bootstrap.Toast.getOrCreateInstance(elementoNotificacao).show();
    }

    function criarNotificacaoOk(mensagem, titulo)
    {
        criarNotificacao(mensagem, titulo);
        criarIconeOk(mensagem, titulo);
        criarCorNotificacao('--cor-verde-escuro');
    }

    function criarNotificacaoError(mensagem, titulo)
    {
        criarNotificacao(mensagem, titulo);
        criarIconeError(mensagem, titulo);
        criarCorNotificacao('--cor-vermelho-escuro');
    }

    function criarNotificacaoAdvertencia(mensagem, titulo)
    {
        criarNotificacao(mensagem, titulo);
        criarIconeAdvertencia(mensagem, titulo);
        criarCorNotificacao('--cor-amarelo-escuro');
    }

    function criarIconeOk(mensagem, titulo)
    {
        document.getElementById('iconeNotificacao').className = '';
        document.getElementById('iconeNotificacao').classList.add('bi', 'bi-check-square');
    }

    function criarIconeError(mensagem, titulo)
    {
        document.getElementById('iconeNotificacao').className = '';
        document.getElementById('iconeNotificacao').classList.add('bi', 'bi-bug');
    }

    function criarIconeAdvertencia(mensagem, titulo)
    {
        document.getElementById('iconeNotificacao').className = '';
        document.getElementById('iconeNotificacao').classList.add('bi', 'bi-exclamation-square');
    }

    function criarCorNotificacao(cor)
    {
        let elementoNotificacao = document.getElementById('notificacao');
        elementoNotificacao.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(cor);
    }


    function criarLoader(elementoPai)
    {
        removerLoader();
        let loader = document.createElement('div');
        loader.id = 'loader';
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        return document.getElementById(elementoPai).appendChild(loader);
    }

    function criarLoaderBolinhas(elementoPai)
    {
        let loader = criarLoader(elementoPai);
        loader.classList.add('lds-roller');
    }

    function criarLoaderBarrinhaCirculo(elementoPai)
    {
        let loader = criarLoader(elementoPai);
        loader.classList.add('lds-ring');
    }

    function removerLoader()
    {
        let loader = document.getElementById('loader');
        if(loader) loader.remove();
    }

    function removerTabelaContatos()
    {
        let tabela = document.getElementById('tabelaContatos');
        if(tabela) tabela.remove();
    }
</script>